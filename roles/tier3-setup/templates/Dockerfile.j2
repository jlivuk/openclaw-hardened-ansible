FROM node:22-alpine

# Install system dependencies (Git, CMake, and linux-headers are required for dependencies)
RUN apk add --no-cache git python3 make g++ cmake linux-headers openssl sqlite bash

# Install OpenClaw globally
# SECURITY: Pinned to 2026.2.15 â€” do not bump without reviewing CVE advisories
# See: CVE-2026-25253 (RCE), GHSA-r8g4-86fx-92mq (LFI), GHSA-q284-4pvr-m585 (command injection)
RUN npm install -g openclaw@2026.2.15

# Create agents directory with per-agent subdirs (writable by node user for session data)
RUN mkdir -p /opt/openclaw/agents \
{% for agent in active_agents %}
    && mkdir -p /opt/openclaw/agents/{{ agent.id }}/sessions \
{% endfor %}
    && chown -R 1000:1000 /opt/openclaw/agents

# Run as non-root user (node:1000)
USER 1000:1000
WORKDIR /home/node

# Default command (force bind to 0.0.0.0 for container networking)
CMD ["openclaw", "gateway", "--allow-unconfigured", "--bind", "lan"]
